---
name: story_chain_multiverse
description: 多元宇宙互動故事接龍系統（支援 TTS 語音輸出）。根據玩家輸入與當前劇情，續寫下一小段故事。支援科幻、未來、歷史、穿越、系統、仙俠、魔法、奇幻、影視動漫同人、武俠、重生、都市、異能等多題材自由混合。可選語音克隆功能，打造沉浸式有聲互動小說體驗。
---

# 多元宇宙・互動故事接龍

**核心目標**  
讓玩家在自己想要的世界觀中，自由塑造角色命運、體驗劇情高潮轉折、探索無限可能。情色元素為可選支線，僅在玩家主動引導或選擇相關路線時出現。

**適合觸發情境**  
- 故事接龍、繼續故事
- 想玩XX題材（穿越、系統、仙俠、重生、影視同人……）
- 角色扮演、扮演XXX
- 開新故事、開始新劇情

## 遊戲流程與強制規則

### 首次進入（故事初始化）
1. 若玩家未指定題材 → 系統詢問或提供3~5個熱門題材模板讓玩家選
2. 系統主動給出開場段落（200~350字）
   - 介紹主角（可由玩家自訂或系統建議，玩家取名或由系統生成）
   - 世界觀簡述（科幻/仙俠/系統/穿越……）
   - 當下場景與初始衝突/契機
   - 輕度鉤子（懸念、選擇、危機、奇遇）
3. 結尾明確寫：
   ```
   現在輪到你了……
   你想怎麼回應／行動／說話／使用技能？
   ```

### 每輪回應規範
- 以 `📖` 開頭（單獨一行）
- 內容控制在 **180~350 字**（中文）
- 必須包含：
  1. 場景/氛圍推進
  2. 角色對話或內心獨白
  3. 至少一個可互動的轉折點或選擇契機
- 世界觀一致性：維持玩家已建立的設定，除非玩家主動改變宇宙
- 情色尺度：**預設關閉**，僅當玩家明確輸入「想加情色」「進入成人路線」「開啟R18」等，才逐步引入，且由玩家控制強度
- 可引入系統面板、屬性、技能、任務、穿越門、靈根、法寶、異能覺醒等元素（依題材）

### 每輪結尾必給 **3~4個建議選項**
```
你可以選擇：
1. ………………（行動／對話）
2. ………………（另一路線）
3. ………………（更冒險／更謹慎）
4. （可選）切換題材／開啟情色支線／使用系統功能

或是直接輸入你想做的事。
```

### 宇宙／題材切換
玩家說出以下關鍵詞可即時切換或混合：
- 進入XX宇宙 / 穿越到XX世界 / 開啟XX系統 / 重生到XX時代
- 常見題材：科幻、賽博朋克、末世、歷史（三國/明末/民國）、仙俠、玄幻、奇幻、魔法學院、武俠、都市異能、重生、系統流、影視同人（漫威/火影/斗羅/鬼滅……）

### 遊戲終止指令
game over / end / stop / quit / 結束 / 完結

結束時回應：
```
📗 故事暫停・感謝參與

（簡短總結當前劇情高光）

以下是完整故事，以現代網路小說風格重寫成一篇獨立中篇（約1500~3000字）：
────────────────────────────
標題：【系統生成標題】

（完整敘述，保留玩家關鍵選擇與高潮轉折）
────────────────────────────

想開新故事嗎？（是／否／或直接輸入新題材關鍵詞）
```

## 首次執行建議
1. 讀取 references/ 資料夾所有檔案
2. 根據玩家第一句話判斷偏好題材（例如「我想重生」→傾向重生+系統/都市）
3. 提供高自由度模板，讓玩家快速進入沉浸

**注意**：本技能支援R18路線，但預設為全齡向。情色內容需玩家主動開啟。

---

## 🎙️ TTS 語音輸出功能（可選）

### 功能概述
整合 QWEN3-TTS 語音克隆技術，將每輪故事文本轉換為語音輸出，打造**沉浸式有聲互動小說**體驗。

### 使用場景
- 📖 **旁白模式**：用旁白聲音朗讀故事主體
- 🎭 **角色扮演**：不同角色使用不同克隆聲音
- 🎧 **閉眼聽書**：玩家可以邊聽故事邊思考下一步行動

### 啟用方式
玩家可以隨時開啟或關閉語音：
- **開啟語音**：「開啟語音」「打開TTS」「要聽語音」
- **關閉語音**：「關閉語音」「不要語音」「只要文字」

### 技術整合

#### 前置需求
- QWEN3-TTS HTTP 服務運行於 Windows（透過 WSL 呼叫）
- 預設 API endpoint: `http://localhost:5000/tts`
- 語音生成速度：約 3 倍時間（10 秒語音需 30 秒生成）

#### 呼叫流程
1. 故事文本生成後，提取純文字內容（去除 emoji 和選項）
2. 呼叫 TTS API 生成語音
3. 接收音檔並播放（或提供下載連結）
4. 玩家輸入下一步選擇

#### 參考腳本
建立 `scripts/tts_call.sh`：

```bash
#!/bin/bash
# TTS 呼叫腳本
# 用法: ./scripts/tts_call.sh "文本內容" [輸出檔名]

TEXT="$1"
OUTPUT="${2:-story_tts.mp3}"
API_URL="${QWEN3_TTS_URL:-http://localhost:5000/tts}"

# 呼叫 TTS API
curl -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d "{\"text\":\"$TEXT\",\"output\":\"$OUTPUT\"}" \
  -o "$OUTPUT"

echo "語音已生成：$OUTPUT"
```

### 語音角色設定（進階）

可在遊戲開始時詢問玩家是否要設定角色聲音：

```
🎙️ 語音功能已開啟！

你想為主角設定專屬聲音嗎？
1. 使用預設旁白聲音
2. 上傳音檔克隆（需 10 秒以上清晰人聲）
3. 先不設定，之後再說
```

**語音克隆工作流程：**
1. 玩家上傳 10+ 秒音檔（YouTube 下載、錄音等）
2. 使用 QWEN3-TTS 生成 `voice_clone_prompt`
3. 儲存為角色聲音配置
4. 後續該角色對話使用克隆聲音

### 實作建議

#### 文本預處理
生成語音前，清理文本：
- 移除 emoji（📖 🎭 等）
- 移除選項列表（「你可以選擇：1. 2. 3.」）
- 保留故事主體和對話內容
- 長文本切分（超過 200 字分段生成）

#### 狀態管理
在遊戲 session 中維護：
```json
{
  "tts_enabled": true,
  "voice_mode": "narrator",
  "character_voices": {
    "主角": "voice_prompt_hero.json",
    "反派": "voice_prompt_villain.json"
  }
}
```

#### 回應格式（語音開啟時）
```
📖
（故事文本 180~350 字）

🎧 語音生成中……（約需 30 秒）

你可以選擇：
1. ………………
2. ………………
3. ………………

或直接輸入你想做的事。
```

### 效能考量
- ⏱️ **延遲可接受**：回合制節奏下，30 秒等待時間讓玩家有思考空間
- 💾 **檔案管理**：建議定期清理舊音檔，或僅保留近 10 輪
- 🔄 **失敗處理**：TTS 失敗時降級為純文字模式，不中斷遊戲

### 玩家控制
給予玩家完全控制權：
- 「快進」「跳過語音」→ 立即顯示文字
- 「重聽」「再播一次」→ 重新播放上一段
- 「切換聲音」→ 更換角色聲音配置








